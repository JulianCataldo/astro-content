---
// NOTE: This file might go in ../integration package,
// so everything purely Astro-related will be in one place,
// but some deps issues prevent this.

import { collect } from '@astro-content/server/collect';
import { log, setLogLevel } from '@astro-content/server/logger';
import { isValidContentBase } from '@astro-content/server/setup';
/* ·········································································· */
import Layout from './layouts/Default.astro';
import App from './components/App';
/* —————————————————————————————————————————————————————————————————————————— */

setLogLevel(import.meta.env.PUBLIC_LOG_LEVEL || 'info');
log(`Log level: ${import.meta.env.PUBLIC_LOG_LEVEL}`);
log('SSR Entrypoint loaded', 'info', 'pretty');

const isValid = isValidContentBase();
// NOTE: Check is done once, not updating (yet)
if (isValid) {
  await collect(
    Astro.glob('/content/**/*.{md,mdx,yaml}'),
    // IDEA: `editMode` could be `mode: 'default' | 'edit' | 'api'`…?
    { editMode: true },
  );

  // TODO: Find a pretty and handy way to handle multiple content bases
  // await collect(
  //   Astro.glob('/node_modules/@astro-content/demo/content/**/*.{md,mdx,yaml}'),
  //   { editMode: true },
  // );
}

// HACK: For ssr-entrypoint first load
// Tried pre-triggering inside hooks etc. didn't worked
const firstLoad = `
window.loaded = false;
setTimeout(() => {
  if (globalThis.loaded === false) {
    location.reload();
    console.log('Reloading…');
  }
}, 1000);`;
---

<Layout>
  <App client:load isValidContentBase={isValid}>
    <script set:html={firstLoad}></script>
  </App>
</Layout>

<script>
  // FIXME: `import/extensions` rule not taking effect for client side Astro JS?
  // eslint-disable-next-line import/extensions
  import { log } from './logger';

  log(`Log level: ${import.meta.env.PUBLIC_LOG_LEVEL}`);
  log('GUI entrypoint loaded', 'info', 'pretty');
</script>
